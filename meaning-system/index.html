import React, { useState, useMemo, useRef, useEffect } from 'react';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, ResponsiveContainer, Legend } from 'recharts';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronLeft, RotateCcw, Share2, X, Download, Lock, ChevronDown, ChevronUp } from 'lucide-react';

const DIMS = [
  { key: 'body', label: 'èº«å¿ƒèƒ½é‡', desc: 'ç¡çœ è´¨é‡ Â· ä½“åŠ›ç²¾åŠ› Â· è¿åŠ¨ä¹ æƒ¯ Â· é¥®é£Ÿè¥å…» Â· èº«ä½“è§‰å¯Ÿ' },
  { key: 'order', label: 'ç§©åºç©ºé—´', desc: 'ç¯å¢ƒæ•´æ´ Â· æ—¶é—´ç®¡ç† Â· è´¢åŠ¡æŒæ§ Â· æ—¥å¸¸èŠ‚å¥ Â· åº”å˜ä»å®¹' },
  { key: 'conn', label: 'äº²å¯†é“¾æ¥', desc: 'æ·±åº¦å…³ç³» Â· è¢«ç†è§£æ„Ÿ Â· çœŸå®è¡¨è¾¾ Â· æƒ…æ„Ÿæ»‹å…» Â· ç¤¾äº¤æ”¯æŒ' },
  { key: 'grow', label: 'æˆé•¿æ¢ç´¢', desc: 'æˆå°±æ„Ÿ Â· æŒç»­å­¦ä¹  Â· ç›®æ ‡é©±åŠ¨ Â· ç»æµèƒ½åŠ› Â· è§†é‡æ‹“å±•' },
  { key: 'inner', label: 'å†…åœ¨æ‚¦çº³', desc: 'è‡ªæˆ‘æ¥çº³ Â· æƒ…ç»ªç¨³å®š Â· ç‹¬å¤„è´¨é‡ Â· è‡ªæˆ‘ä»·å€¼ Â· å¤åŸéŸ§æ€§' },
];
const VALID_CODES = ['R98U-DDF5','LLDJ-FUAG','GGDL-PBSA','2WUR-5Y7T','X986-DVUJ'];

const Q1 = [
  { d:'body', t:'æœ€è¿‘ä¸€ä¸ªæœˆï¼Œä½ å¯¹è‡ªå·±çš„ç¡çœ è´¨é‡æ»¡æ„å—ï¼Ÿ' },
  { d:'order', t:'ä½ çš„ç”Ÿæ´»ç©ºé—´æ˜¯å¦è®©ä½ æ„Ÿåˆ°èˆ’é€‚æœ‰åºï¼Ÿ' },
  { d:'conn', t:'ä½ èº«è¾¹æœ‰å¯ä»¥è¯´å¿ƒé‡Œè¯çš„äººå—ï¼Ÿ' },
  { d:'grow', t:'ä½ ç›®å‰çš„å·¥ä½œæˆ–å­¦ä¹ æ˜¯å¦è®©ä½ æœ‰æˆå°±æ„Ÿï¼Ÿ' },
  { d:'inner', t:'ä½ èƒ½å¹³é™åœ°æ¥çº³è‡ªå·±å½“ä¸‹çš„çŠ¶æ€å—ï¼Ÿ' },
  { d:'body', t:'ä½ æ¯å‘¨ä¼šæœ‰è§„å¾‹åœ°è¿›è¡Œèº«ä½“æ´»åŠ¨å—ï¼Ÿ' },
  { d:'order', t:'ä½ å¯¹è‡ªå·±ç›®å‰çš„æ—¶é—´å®‰æ’æ»¡æ„å—ï¼Ÿ' },
  { d:'conn', t:'ä½ å¯¹å½“å‰çš„äº²å¯†å…³ç³»çŠ¶æ€æ»¡æ„å—ï¼Ÿ' },
  { d:'grow', t:'ä½ æœ€è¿‘åŠå¹´æœ‰åœ¨å­¦ä¹ æ–°ä¸œè¥¿æˆ–æ¢ç´¢æ–°é¢†åŸŸå—ï¼Ÿ' },
  { d:'inner', t:'ä½ ç‹¬å¤„æ—¶èƒ½æ„Ÿåˆ°è‡ªåœ¨å’Œå……å®å—ï¼Ÿ' },
  { d:'body', t:'ä½ æ—¥å¸¸çš„ç²¾åŠ›æ°´å¹³èƒ½æ”¯æ’‘ä½ å®Œæˆæƒ³åšçš„äº‹å—ï¼Ÿ' },
  { d:'order', t:'ä½ å¯¹å½“å‰çš„è´¢åŠ¡çŠ¶å†µæœ‰æ¸…æ™°çš„æŒæ§æ„Ÿå—ï¼Ÿ' },
  { d:'conn', t:'ä½ ä¸äº²è¿‘çš„äººçš„å…³ç³»æ˜¯å¦ç»™ä½ å¸¦æ¥æ»‹å…»è€Œéæ¶ˆè€—ï¼Ÿ' },
  { d:'grow', t:'ä½ å¯¹è‡ªå·±å½“å‰çš„æ”¶å…¥æˆ–ç»æµèƒ½åŠ›æ»¡æ„å—ï¼Ÿ' },
  { d:'inner', t:'æœ€è¿‘ä¸€ä¸ªæœˆï¼Œä½ çš„æƒ…ç»ªæ•´ä½“æ˜¯ç¨³å®šçš„å—ï¼Ÿ' },
  { d:'body', t:'ä½ æ˜¯å¦æœ‰æ„è¯†åœ°å…³æ³¨è‡ªå·±çš„é¥®é£Ÿå’Œè¥å…»ï¼Ÿ' },
  { d:'order', t:'ä½ æ˜¯å¦æœ‰ç¨³å®šä¸”è®©ä½ èˆ’æœçš„æ—¥å¸¸èŠ‚å¥ï¼Ÿ' },
  { d:'conn', t:'æœ€è¿‘ä¸€ä¸ªæœˆï¼Œä½ æœ‰è¿‡è¢«ç†è§£å’Œè¢«çœ‹è§çš„å¯¹è¯å—ï¼Ÿ' },
  { d:'grow', t:'ä½ ç›®å‰æœ‰æ­£åœ¨è®¤çœŸè¿½æ±‚çš„ç›®æ ‡å—ï¼Ÿ' },
  { d:'inner', t:'ä½ è§‰å¾—è‡ªå·±å€¼å¾—æ‹¥æœ‰å¥½çš„ç”Ÿæ´»å’Œå…³ç³»å—ï¼Ÿ' },
  { d:'body', t:'å½“èº«ä½“å‘å‡ºç–²æƒ«ä¿¡å·æ—¶ï¼Œä½ èƒ½åŠæ—¶è®©è‡ªå·±ä¼‘æ¯å—ï¼Ÿ' },
  { d:'order', t:'é¢å¯¹è®¡åˆ’å¤–çš„å˜åŠ¨ï¼Œä½ èƒ½æ¯”è¾ƒä»å®¹åœ°åº”å¯¹å—ï¼Ÿ' },
  { d:'conn', t:'ä½ åœ¨äººé™…äº¤å¾€ä¸­èƒ½æ¯”è¾ƒçœŸå®åœ°è¡¨è¾¾è‡ªå·±å—ï¼Ÿ' },
  { d:'grow', t:'ä½ æ˜¯å¦ä¼šä¸»åŠ¨æ¥è§¦ä¸åŒçš„è§‚ç‚¹å’Œåœˆå­ï¼Ÿ' },
  { d:'inner', t:'é­é‡æŒ«æŠ˜åï¼Œä½ èƒ½æ¯”è¾ƒå¿«åœ°æ‰¾å›å†…å¿ƒçš„å¹³è¡¡å—ï¼Ÿ' },
];
const Q2 = [
  { d:'body', t:'æ‹¥æœ‰å……æ²›çš„ä½“åŠ›å’Œæ—ºç››çš„ç²¾åŠ›ï¼Œå¯¹ä½ æ¥è¯´é‡è¦å—ï¼Ÿ' },
  { d:'order', t:'ä½ æœ‰å¤šæ¸´æœ›ä¸€ä¸ªäº•ç„¶æœ‰åºçš„ç”Ÿæ´»ç¯å¢ƒï¼Ÿ' },
  { d:'conn', t:'æ·±åº¦çš„äººé™…å…³ç³»å¯¹ä½ æ¥è¯´æœ‰å¤šé‡è¦ï¼Ÿ' },
  { d:'grow', t:'åœ¨äº‹ä¸šæˆ–ä¸“ä¸šä¸ŠæŒç»­è¿›æ­¥å¯¹ä½ é‡è¦å—ï¼Ÿ' },
  { d:'inner', t:'å†…å¿ƒçš„å®‰å®å’Œå¹³é™å¯¹ä½ æœ‰å¤šé‡è¦ï¼Ÿ' },
  { d:'body', t:'ä½ æœ‰å¤šæ¸´æœ›å»ºç«‹ä¸€å¥—é€‚åˆè‡ªå·±çš„å¥åº·ä¹ æƒ¯ï¼Ÿ' },
  { d:'order', t:'æ‹¥æœ‰è´¢åŠ¡å®‰å…¨æ„Ÿæ˜¯ä½ å¼ºçƒˆçš„å†…åœ¨éœ€æ±‚å—ï¼Ÿ' },
  { d:'conn', t:'ä½ æœ‰å¤šæ¸´æœ›åœ¨å…³ç³»ä¸­è¢«çœŸæ­£ç†è§£ï¼Ÿ' },
  { d:'grow', t:'ä½ æœ‰å¤šæ¸´æœ›æ‹“å®½è‡ªå·±çš„è®¤çŸ¥è¾¹ç•Œï¼Ÿ' },
  { d:'inner', t:'ä½ æœ‰å¤šæ¸´æœ›èƒ½çœŸæ­£æ¥çº³å’Œæ¬£èµè‡ªå·±ï¼Ÿ' },
  { d:'body', t:'å¦‚æœåªèƒ½ä¼˜å…ˆæ”¹å–„ä¸€ä»¶äº‹ï¼Œ"ç¡ä¸ªå¥½è§‰"ä¼šæ˜¯ä½ çš„é€‰é¡¹å—ï¼Ÿ' },
  { d:'order', t:'ä½ æœ‰å¤šå¸Œæœ›è‡ªå·±èƒ½æ›´å¥½åœ°è§„åˆ’æ—¶é—´ï¼Ÿ' },
  { d:'conn', t:'æ‹¥æœ‰ä¸€ä¸ªæ¸©æš–çš„æ”¯æŒç½‘ç»œå¯¹ä½ æœ‰å¸å¼•åŠ›å—ï¼Ÿ' },
  { d:'grow', t:'æå‡åˆ›é€ æ”¶å…¥çš„èƒ½åŠ›æ˜¯ä½ å½“å‰çš„é©±åŠ¨åŠ›å—ï¼Ÿ' },
  { d:'inner', t:'æå‡æƒ…ç»ªç®¡ç†èƒ½åŠ›æ˜¯ä½ æƒ³åŠªåŠ›çš„æ–¹å‘å—ï¼Ÿ' },
  { d:'body', t:'é€šè¿‡æå‡èº«ä½“çŠ¶æ€æ¥æ”¹å–„æ€ç»´å’Œæƒ…ç»ªï¼Œè¿™å¯¹ä½ æœ‰å¸å¼•åŠ›å—ï¼Ÿ' },
  { d:'order', t:'å»ºç«‹ç¨³å®šçš„ç”Ÿæ´»èŠ‚å¥å’Œä»ªå¼æ„Ÿå¯¹ä½ æœ‰å¸å¼•åŠ›å—ï¼Ÿ' },
  { d:'conn', t:'ä½ æ„¿æ„ä¸ºé‡è¦å…³ç³»æŠ•å…¥æ›´å¤šæ—¶é—´å’Œç²¾åŠ›å—ï¼Ÿ' },
  { d:'grow', t:'å­¦ä¹ ä¸€é¡¹å…¨æ–°çš„æŠ€èƒ½ä¼šè®©ä½ æ„Ÿåˆ°å…´å¥‹å—ï¼Ÿ' },
  { d:'inner', t:'ä½ æœ‰å¤šæƒ³æ‹¥æœ‰é«˜è´¨é‡çš„ç‹¬å¤„æ—¶å…‰ï¼Ÿ' },
  { d:'body', t:'ä½ æ„¿æ„æŠŠ"ç…§é¡¾å¥½èº«ä½“"å½“ä½œæ¯æ—¥ä¼˜å…ˆäº‹é¡¹å—ï¼Ÿ' },
  { d:'order', t:'ä½ æœ‰å¤šæƒ³å‡å°‘ç”Ÿæ´»ä¸­"å¤±æ§"çš„æ„Ÿè§‰ï¼Ÿ' },
  { d:'conn', t:'ä½ è§‰å¾—"çˆ±ä¸è¢«çˆ±çš„èƒ½åŠ›"æ˜¯ä½ çš„æ ¸å¿ƒéœ€æ±‚å—ï¼Ÿ' },
  { d:'grow', t:'ä½ æœ‰å¤šæƒ³åœ¨æŸä¸ªé¢†åŸŸåšå‡ºå±äºè‡ªå·±çš„æˆç»©ï¼Ÿ' },
  { d:'inner', t:'"æ´»å‡ºçœŸå®çš„è‡ªå·±"å¯¹ä½ æœ‰å¤šé‡è¦ï¼Ÿ' },
];
const O1 = ['å®Œå…¨ä¸ç¬¦åˆ','æ¯”è¾ƒä¸ç¬¦åˆ','è¯´ä¸å¥½','æ¯”è¾ƒç¬¦åˆ','éå¸¸ç¬¦åˆ'];
const O2 = ['å‡ ä¹æ²¡æƒ³è¿‡','å¶å°”åœ¨æ„','æœ‰äº›å‘å¾€','æ¯”è¾ƒæ¸´æœ›','å¼ºçƒˆæ¸´æœ›'];

function calc(ans, qs) {
  const s = {}, c = {};
  DIMS.forEach(d => { s[d.key] = 0; c[d.key] = 0; });
  qs.forEach((q, i) => { if (ans[i] > 0) { s[q.d] += ans[i]; c[q.d]++; } });
  const o = {};
  DIMS.forEach(d => { const a = c[d.key] > 0 ? s[d.key] / c[d.key] : 3; o[d.key] = Math.round((a - 1) / 4 * 100); });
  return o;
}
function ana(s1, s2) {
  const ks = DIMS.map(d => d.key);
  const b1 = [...ks].sort((a, b) => s1[b] - s1[a]);
  const b2 = [...ks].sort((a, b) => s2[b] - s2[a]);
  const gaps = {}; ks.forEach(k => gaps[k] = s2[k] - s1[k]);
  const bg = [...ks].sort((a, b) => gaps[b] - gaps[a]);
  const s2v = ks.map(k => s2[k]);
  return { strong: b1[0], weak: b1[4], drive: b2[0], gapDim: bg[0], gaps, bal: s1[b1[0]] - s1[b1[4]] <= 10, desireBal: Math.max(...s2v) - Math.min(...s2v) <= 15 };
}
const dl = k => DIMS.find(d => d.key === k)?.label || '';

function getType(s1, s2) {
  const { drive } = ana(s1, s2);
  const cl = s1[drive] >= 50 ? 'h' : 'l';
  const v2 = Object.values(s2);
  if (Math.max(...v2) - Math.min(...v2) <= 15) {
    const av = Object.values(s1).reduce((a, b) => a + b, 0) / 5;
    return av >= 55 ? { name: 'å…¨æ¯è¡Œè€…', tag: 'ä½ å·²ç„¶æ‹¥æœ‰è§‰çŸ¥çš„å‡è¡¡ï¼Œä¸‹ä¸€æ­¥æ˜¯é€‰æ‹©ä¸€ä¸ªæ–¹å‘æ·±å…¥ç²¾è¿›' } : { name: 'ç”Ÿæ´»ç‚¼é‡‘å¸ˆ', tag: 'ä½ æ¸´æœ›å…¨é¢èœ•å˜ï¼Œæ¯ä¸€ä¸ªç»´åº¦éƒ½åœ¨å¬å”¤ä½ ' };
  }
  const T = {
    body: { h:{ name:'å±±é—´æ¸…æ³‰', tag:'èº«å¿ƒå……ç›ˆæ˜¯ä½ çš„åº•è‰²ï¼Œä½ æ­£ä»èº«ä½“é‡Œæ±²å–ç”Ÿå‘½çš„åŠ›é‡' }, l:{ name:'æ²‰ç¡å·¨é²¸', tag:'ä½ çš„èº«ä½“é‡Œæ²‰ç¡ç€å·¨å¤§çš„èƒ½é‡ï¼Œæ­£ç­‰å¾…ä¸€æ¬¡æ¸©æŸ”çš„å”¤é†’' } },
    order: { h:{ name:'æ—¶å…‰é’Ÿè¡¨åŒ ', tag:'ç§©åºæ˜¯ä½ çš„å®‰å…¨æ„Ÿæ¥æºï¼Œä½ æ“…é•¿åœ¨ç»“æ„ä¸­æ‰¾åˆ°è‡ªç”±' }, l:{ name:'æ··æ²Œå»ºç­‘å¸ˆ', tag:'ä½ æ¸´æœ›ä»æ··æ²Œä¸­æ­å»ºå±äºè‡ªå·±çš„ç§©åºå®«æ®¿' } },
    conn: { h:{ name:'æ¸©æš–ç£åœº', tag:'ä½ çš„ä¸–ç•Œå› è”ç»“è€Œä¸°ç››ï¼Œå…³ç³»æ˜¯ä½ æœ€é‡è¦çš„èƒ½é‡æ¥æº' }, l:{ name:'ç‹¬è¡Œæš–å…‰', tag:'ä½ å¿ƒä¸­æœ‰ä¸€å›¢æ¸©æš–çš„å…‰ï¼Œæ­£åœ¨å¯»æ‰¾å€¼å¾—ç…§äº®çš„äºº' } },
    grow: { h:{ name:'æ˜Ÿé™…é¢†èˆªå‘˜', tag:'æˆé•¿æ˜¯ä½ çš„æ¯è¯­ï¼Œä½ å·²ç»åœ¨é€šå¾€æ˜Ÿè¾°çš„èˆªçº¿ä¸Š' }, l:{ name:'è›°ä¼ç«å±±', tag:'å·¨å¤§çš„æˆé•¿æ¸´æœ›æ­£åœ¨ä½ å¿ƒä¸­è“„ç§¯ï¼Œå³å°†è¿æ¥å–·å‘æ—¶åˆ»' } },
    inner: { h:{ name:'é™æ°´æ·±æµ', tag:'ä½ çš„å†…å¿ƒå·²æœ‰æ·±åšçš„å®é™ï¼Œæ­£åœ¨å‘æ›´æ·±å¤„æ¢ç´¢è‡ªæˆ‘' }, l:{ name:'è¿·é›¾å¯»ç¯äºº', tag:'ä½ æ­£ç©¿è¶Šæƒ…ç»ªçš„è¿·é›¾ï¼Œå¯»æ‰¾å±äºè‡ªå·±çš„å†…å¿ƒæ˜ç¯' } },
  };
  return T[drive]?.[cl] || { name: 'æ¢ç´¢è€…', tag: 'ä½ æ­£åœ¨äººç”Ÿçš„æ—·é‡ä¸Šå¯»æ‰¾æ–¹å‘' };
}

function getInterp(s1, s2) {
  const { strong, weak, drive, gapDim, gaps, bal, desireBal } = ana(s1, s2);
  const av = Math.round(Object.values(s1).reduce((a, b) => a + b, 0) / 5);
  const av2 = Math.round(Object.values(s2).reduce((a, b) => a + b, 0) / 5);
  const allHigh = Object.values(s1).every(v => v >= 80);
  let t = '';
  if (allHigh && bal) {
    t += 'ä½ åœ¨äº”ä¸ªç»´åº¦ä¸Šéƒ½å±•ç°å‡ºäº†å¾ˆé«˜çš„æ»¡æ„åº¦ï¼Œæ‹¥æœ‰ä»¤äººæ¬£èµçš„ç”Ÿå‘½è´¨é‡ã€‚è¿™ç§å…¨é¢ä¸”ç¨³å®šçš„çŠ¶æ€éå¸¸éš¾å¾—ï¼Œè¯´æ˜ä½ å·²ç»åœ¨ç”¨å¿ƒç»è¥ç€ä¸€ç§é«˜å“è´¨çš„ç”Ÿæ´»ã€‚';
  } else {
    if (av >= 65) t += 'ä½ å½“å‰çš„æ•´ä½“ç”Ÿå‘½èƒ½é‡å¤„äºè¾ƒä¸ºå……æ²›çš„çŠ¶æ€ï¼Œè¯´æ˜ä½ å·²ç»åœ¨ç”Ÿæ´»çš„å¤šä¸ªå±‚é¢å»ºç«‹äº†ä¸é”™çš„åŸºç¡€ï¼Œè¿™éå¸¸å€¼å¾—è‚¯å®šã€‚';
    else if (av >= 40) t += 'ä½ å½“å‰çš„æ•´ä½“èƒ½é‡å¤„äºä¸­ç­‰æ°´å¹³ï¼Œç”Ÿæ´»ä¸­æœ‰ç»è¥å¾—ä¸é”™çš„é¢†åŸŸï¼Œä¹Ÿæœ‰éœ€è¦å…³æ³¨çš„è§’è½â€”â€”è¿™æ˜¯å¤§å¤šæ•°äººçš„å¸¸æ€ï¼Œè¯·ä¸è¦è‹›è´£è‡ªå·±ã€‚';
    else t += 'ä½ å½“å‰çš„ç”Ÿå‘½èƒ½é‡æ•´ä½“åä½ï¼Œå¯èƒ½æ­£ç»å†ä¸€æ®µæ¶ˆè€—è¾ƒå¤§çš„æ—¶æœŸã€‚ä½†è¯·è®°ä½ï¼Œæ„¿æ„ç›´é¢è‡ªå·±çš„çŠ¶æ€ï¼Œæœ¬èº«å°±æ˜¯äº†ä¸èµ·çš„å‹‡æ°”ã€‚';
    if (bal) { t += 'ä½ äº”ä¸ªç»´åº¦çš„ç°çŠ¶å¾—åˆ†ç›¸å½“å‡è¡¡ï¼Œæ²¡æœ‰ç‰¹åˆ«çªå‡ºçš„çŸ­æ¿ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€ç§æ•´ä½“è·ƒå‡çš„å¯èƒ½æ€§åœ¨ç­‰å¾…ä½ ã€‚'; }
    else { t += `åœ¨äº”ä¸ªç»´åº¦ä¸­ï¼Œã€Œ${dl(strong)}ã€æ˜¯ä½ å½“å‰æœ€ç¨³å›ºçš„é¢†åŸŸï¼ˆ${s1[strong]}åˆ†ï¼‰ï¼Œå®ƒæ˜¯ä½ é¢å¯¹ç”Ÿæ´»é£æµªæ—¶æœ€åšå®çš„é”šç‚¹ã€‚è€Œã€Œ${dl(weak)}ã€ç›®å‰å¾—åˆ†è¾ƒä½ï¼ˆ${s1[weak]}åˆ†ï¼‰ï¼Œå¯èƒ½æ˜¯è¿‘æœŸè®©ä½ æ„Ÿåˆ°æ¶ˆè€—æˆ–ä¸å®‰çš„ä¸»è¦æ¥æºï¼Œä¹Ÿæ˜¯æœ€å€¼å¾—æŠ•æ³¨å…³æ€€çš„æ–¹å‘ã€‚`; }
  }
  if (desireBal) {
    if (av2 >= 80) t += 'ä½ å¯¹ç”Ÿæ´»å„ç»´åº¦éƒ½æ€€æœ‰å¼ºçƒˆè€Œå‡è¡¡çš„æ¸´æœ›ï¼Œä½ æ¸´æœ›çš„ä¸æ˜¯æŸä¸ªå•ç‚¹çš„çªç ´ï¼Œè€Œæ˜¯æ•´ä½“çš„ç”Ÿå‘½èœ•å˜ã€‚';
    else t += 'ä½ å¯¹å„ä¸ªç»´åº¦çš„æ¸´æœ›ç¨‹åº¦æ¯”è¾ƒå‡è¡¡ï¼Œå¯ä»¥é€‰æ‹©ä»»ä½•ä¸€ä¸ªæœ€é¡ºæ‰‹çš„ç»´åº¦ä½œä¸ºèµ·ç‚¹ã€‚';
  } else {
    if (drive === strong) t += `å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½ æœ€å¼ºçš„é¢†åŸŸæ°å¥½ä¹Ÿæ˜¯ä½ æœ€åœ¨æ„çš„æ–¹å‘â€”â€”ä½ å¯¹ã€Œ${dl(drive)}ã€æ—¢æœ‰ç§¯ç´¯åˆæœ‰çƒ­æƒ…ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸æœ‰åŠ›çš„ç»„åˆï¼Œå¯ä»¥æˆä¸ºæ’¬åŠ¨å…¶ä»–æ”¹å˜çš„æ ¸å¿ƒæ”¯ç‚¹ã€‚`;
    else t += `ä½ å†…å¿ƒæœ€å¼ºçƒˆçš„æ¸´æœ›æŒ‡å‘ã€Œ${dl(drive)}ã€ï¼ˆæ¸´æœ›å€¼${s2[drive]}åˆ†ï¼‰ï¼Œè¿™è‚¡å†…é©±åŠ›æ˜¯æ¨åŠ¨ä½ å‘å‰çš„å…³é”®èƒ½é‡ã€‚`;
  }
  if (!desireBal && gaps[gapDim] > 25) t += `å°¤å…¶åœ¨ã€Œ${dl(gapDim)}ã€ç»´åº¦ä¸Šï¼Œä½ çš„æ¸´æœ›è¿œè¶…ç°çŠ¶ï¼Œè¿™é‡Œå­˜åœ¨æ˜¾è‘—çš„æˆé•¿ç©ºé—´â€”â€”å®ƒæ—¢æ˜¯ä½ çš„ç—›ç‚¹ï¼Œä¹Ÿå¯èƒ½æˆä¸ºæœ€å¤§çš„çªç ´å£ã€‚`;
  return t;
}

function getSugg(s1, s2) {
  const allEqual = Object.values(s1).every(v => v === Object.values(s1)[0]);
  if (allEqual && s1[DIMS[0].key] >= 80) {
    return [
      { title: 'å‘æ›´æ·±å¤„æ¢ç´¢', text: 'ä½ çš„äº”ä¸ªç»´åº¦å·²ç»éå¸¸å‡è¡¡ä¸”å……å®ã€‚è¿™ä¸ªé˜¶æ®µçš„æˆé•¿ä¸å†æ˜¯"è¡¥çŸ­æ¿"ï¼Œè€Œæ˜¯åœ¨æŸä¸ªæœ€è®©ä½ å¿ƒåŠ¨çš„æ–¹å‘ä¸Šåšæ·±åº¦çªç ´ã€‚é€‰æ‹©ä¸€ä¸ªè®©ä½ æ„Ÿåˆ°å…´å¥‹çš„é¢†åŸŸï¼ŒæŠ•å…¥çƒ­æƒ…å»ç²¾è¿›â€”â€”ä»"å‡è¡¡çš„å¥½"èµ°å‘"æœ‰ç‰¹è‰²çš„å“è¶Š"ã€‚' },
      { title: 'æˆä¸ºä»–äººçš„æ”¯ç‚¹', text: 'å½“è‡ªå·±çš„ç”Ÿå‘½å·²ç»ç›¸å½“ç¨³å›ºï¼Œæœ€æœ‰æ„ä¹‰çš„ä¸‹ä¸€æ­¥å¾€å¾€æ˜¯å‘å¤–å»¶ä¼¸ã€‚ä½ å¯ä»¥ç”¨è‡ªå·±çš„ç»éªŒå’Œèƒ½é‡å»æ”¯æŒèº«è¾¹çš„äººâ€”â€”åˆ†äº«ä½ çš„æ–¹æ³•ã€å€¾å¬ä»–ä»¬çš„å›°æƒ‘ã€åˆ›é€ æ›´å¤šæœ‰è´¨é‡çš„è”ç»“ã€‚' },
      { title: 'ä¿æŒè§‰å¯Ÿä¸å¼¹æ€§', text: 'é«˜åˆ†å¹¶ä¸æ„å‘³ç€æ°¸è¿œä¸ä¼šæ³¢åŠ¨â€”â€”ç”Ÿæ´»æœ¬èº«å°±æ˜¯åŠ¨æ€çš„ã€‚ä¿æŒå¯¹è‡ªå·±çŠ¶æ€çš„æ¸©æŸ”è§‰å¯Ÿï¼Œåœ¨æ³¢åŠ¨æ¥ä¸´æ—¶ä¸ç„¦è™‘ã€ä¸è‡ªè´£ï¼Œä»å®¹åº”å¯¹ã€‚ä½ å·²ç»è¯æ˜äº†è‡ªå·±æœ‰èƒ½åŠ›å»ºè®¾å¥½çš„ç”Ÿæ´»ã€‚' },
    ];
  }
  const { strong, weak, drive } = ana(s1, s2);
  const tips = {
    body: { up: 'ä»ä¸€ä¸ªå¾®å°çš„èº«ä½“ä¹ æƒ¯å¼€å§‹ï¼šæ¯å¤©10åˆ†é’Ÿæ•£æ­¥ã€ä¸€ä¸ªå›ºå®šçš„å…¥ç¡æ—¶é—´ã€æˆ–ä¸€é¡¿è®¤çœŸå‡†å¤‡çš„é¥­ã€‚å½“èº«ä½“è¢«å¥½å¥½å¯¹å¾…ï¼Œç²¾åŠ›å’Œå¿ƒæƒ…éƒ½ä¼šæ‚„ç„¶å›å‡ã€‚', use: 'ä½ çš„èº«å¿ƒèƒ½é‡æ˜¯æœ€å¤§çš„èµ„äº§ã€‚å°è¯•ç”¨å®ƒå¸¦åŠ¨å…¶ä»–é¢†åŸŸâ€”â€”ç”¨æ™¨é—´æ´»åŠ¨çš„æ¸…é†’æ„Ÿå¯åŠ¨é«˜æ•ˆå·¥ä½œï¼Œç”¨å¥½å¥½åƒé¥­æ¥åˆ›é€ ä¸äººè”ç»“çš„æ—¶åˆ»ã€‚' },
    order: { up: 'é€‰æ‹©ä¸€ä¸ªæœ€å›°æ‰°ä½ çš„"æ··ä¹±è§’è½"å¼€å§‹ï¼šå †æ»¡ä¸œè¥¿çš„æ¡Œé¢ã€ä¸€å›¢ä¹±éº»çš„æ—¥ç¨‹ã€æˆ–ä»æœªç†è¿‡çš„è´¦ç›®ã€‚ç§©åºæ„Ÿåƒæ¶Ÿæ¼ªï¼Œä»ä¸€ä¸ªå°å°çš„åœ†å¿ƒå°±èƒ½æ‰©æ•£åˆ°æ•´ä¸ªæ°´é¢ã€‚', use: 'ä½ çš„ç§©åºæ„Ÿæ˜¯è¶…èƒ½åŠ›ã€‚è¯•ç€ä¸ºæœ€æƒ³æ”¹å–„çš„é¢†åŸŸè®¾è®¡ä¸€ä¸ªæç®€ç³»ç»Ÿâ€”â€”è¿½è¸ªè¡¨ã€å›ºå®šæ—¶é—´å—ã€æˆ–å°å°çš„æ—¥å¸¸ä»ªå¼ã€‚ç»“æ„ä¸æ˜¯æŸç¼šï¼Œå®ƒæ˜¯è®©è‡ªç”±ç”Ÿé•¿çš„éª¨æ¶ã€‚' },
    conn: { up: 'æœ¬å‘¨æ‰¾ä¸€ä¸ªä½ åœ¨æ„çš„äººï¼Œè¿›è¡Œä¸€æ¬¡ä¸å¸¦æ‰‹æœºçš„æ·±åº¦å¯¹è¯ã€‚è”ç»“ä¸éœ€è¦å®å¤§çš„ä»ªå¼ï¼Œå®ƒåœ¨æ¯ä¸€ä¸ªçœŸè¯šçš„"ä½ æœ€è¿‘å¥½å—ï¼Ÿ"é‡Œæ‚„ç„¶å‘ç”Ÿã€‚', use: 'å…³ç³»æ˜¯ä½ æœ€å¯Œè¶³çš„é¢†åŸŸã€‚è¯•ç€å€ŸåŠ©å®ƒæ»‹å…»å…¶ä»–ç»´åº¦â€”â€”å’Œæœ‹å‹ä¸€èµ·è¿åŠ¨ã€æ‰¾å¿—åŒé“åˆçš„äººå…±åŒå­¦ä¹ ã€åœ¨ä¿¡ä»»çš„äººé¢å‰ç»ƒä¹ è¡¨è¾¾è„†å¼±ã€‚' },
    grow: { up: 'æ‰¾åˆ°ä¸€ä»¶è®©ä½ å¥½å¥‡çš„å°äº‹ï¼Œç»™è‡ªå·±30å¤©æ¢ç´¢æœŸã€‚ä¸å¿…è¿½æ±‚"æœ‰ç”¨"ï¼Œä¸å¿…æ€¥äºçœ‹åˆ°ç»“æœã€‚æˆé•¿çš„å¼•æ“ä¸€æ—¦å¯åŠ¨ï¼Œä¼šè‡ªå·±æ‰¾åˆ°åŠ é€Ÿçš„æ–¹å‘ã€‚', use: 'ä½ çš„æˆé•¿åŠ¨åŠ›æ˜¯æœ€å¼ºçš„å‘åŠ¨æœºã€‚å…³é”®æ˜¯ä¸ºå®ƒé€‰æ‹©ä¸€æ¡è·‘é“â€”â€”ä¸å…¶åˆ†æ•£ç²¾åŠ›åœ¨å¤šä¸ªæ–¹å‘ï¼Œä¸å¦‚é€‰å®šä¸€ä¸ªç›®æ ‡æ·±æ‰ä¸‰ä¸ªæœˆã€‚' },
    inner: { up: 'æ¯å¤©ç»™è‡ªå·±15åˆ†é’Ÿ"çº¯ç²¹ç‹¬å¤„"â€”â€”ä¸åˆ·æ‰‹æœºã€ä¸è®¡åˆ’ã€ä¸åæ€ï¼Œåªæ˜¯å®‰é™åœ°å’Œè‡ªå·±å¾…ä¸€ä¼šå„¿ã€‚ä¹Ÿå¯ä»¥å†™ä¸‰è¡Œæ—¥è®°ï¼šä¸€ä¸ªæ„Ÿå—ã€ä¸€ä¸ªå‘ç°ã€ä¸€å¥æ¸©æŸ”çš„è¯ã€‚', use: 'ä½ çš„å†…åœ¨ç¨³å®šæ€§æ˜¯æœ€æ·±çš„æ ¹åŸºã€‚è¯•ç€æŠŠè‡ªæˆ‘è§‰å¯Ÿå¸¦å…¥æƒ³æ”¹å–„çš„é¢†åŸŸâ€”â€”ç”¨æ­£å¿µé¢å¯¹ç„¦è™‘ï¼Œç”¨è‡ªæˆ‘æ¥çº³çš„å¿ƒæ€å¼€å§‹å­¦ä¹ ï¼Œç”¨å†…å¿ƒçš„å¹³é™å»ç»è¥å…³ç³»ã€‚' },
  };
  const r = [];
  r.push({ title: `ä»¥ã€Œ${dl(strong)}ã€ä¸ºæ”¯ç‚¹`, text: tips[strong]?.use || '' });
  if (weak !== strong) { r.push({ title: s1[weak] >= 80 ? `ç²¾è¿›ã€Œ${dl(weak)}ã€` : `è¡¥ç»™ã€Œ${dl(weak)}ã€çš„èƒ½é‡`, text: s1[weak] >= 80 ? (tips[weak]?.use || '') : (tips[weak]?.up || '') }); }
  if (drive !== strong && drive !== weak) r.push({ title: `è¿½éšã€Œ${dl(drive)}ã€çš„å¬å”¤`, text: tips[drive]?.up || '' });
  if (r.length < 3) r.push({ title: 'ç»™è‡ªå·±ä¸€äº›è€å¿ƒ', text: 'æ”¹å˜ä¸å¿…ä¸€è¹´è€Œå°±ã€‚é€‰æ‹©ä¸€ä¸ªæœ€è®©ä½ å¿ƒåŠ¨çš„æ–¹å‘ï¼Œç”¨æœ€å°çš„è¡ŒåŠ¨å¼€å§‹ï¼Œç„¶åå…è®¸è‡ªå·±æ…¢æ…¢æ¥ã€‚æ¯ä¸€å¤©å¾®å°çš„é€‰æ‹©ï¼Œéƒ½åœ¨ä¸ºä½ å»ºé€ ä¸€ä¸ªä¸ä¸€æ ·çš„æœªæ¥ã€‚' });
  return r;
}

function wrapText(ctx, text, maxW) {
  const lines = []; let cur = '';
  for (let i = 0; i < text.length; i++) {
    const test = cur + text[i];
    if (ctx.measureText(test).width > maxW) { lines.push(cur); cur = text[i]; } else cur = test;
  }
  if (cur) lines.push(cur); return lines;
}
function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath(); ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y); ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r); ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h); ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r); ctx.quadraticCurveTo(x, y, x + r, y); ctx.closePath();
}

function drawPoster(canvas, type, sc1, sc2, interp) {
  const W = 750, PAD = 60;
  const mc = document.createElement('canvas'); mc.width = W; mc.height = 1;
  const mx = mc.getContext('2d');
  mx.font = '400 20px Georgia,serif';
  const tagLs = wrapText(mx, type.tag, W - 140);
  mx.font = '400 14px Georgia,serif';
  const allIL = wrapText(mx, interp, W - PAD * 2 - 40);
  const iL = allIL.slice(0, 6); const hasMore = allIL.length > 6;
  const iLC = iL.length + (hasMore ? 1 : 0);
  let H = 48 + 24 + 40 + 44 + 32 + tagLs.length * 28 + 24 + 220 + 28 + 5 * 36 + 16 + iLC * 20 + 44 + 70;
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');
  const bg = ctx.createLinearGradient(0, 0, 0, H);
  bg.addColorStop(0, '#fef7ed'); bg.addColorStop(0.5, '#fffbf5'); bg.addColorStop(1, '#fef3e2');
  ctx.fillStyle = bg; ctx.fillRect(0, 0, W, H);
  ctx.globalAlpha = 0.05; ctx.fillStyle = '#92400e';
  ctx.beginPath(); ctx.arc(620, 150, 170, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(130, H - 180, 120, 0, Math.PI * 2); ctx.fill();
  ctx.globalAlpha = 1;
  let y = 48;
  ctx.fillStyle = '#a8a29e'; ctx.font = '500 17px Georgia,serif'; ctx.textAlign = 'center';
  ctx.fillText('MY LIFE FULCRUM Â· 2026', W / 2, y); y += 22;
  ctx.strokeStyle = '#d6d3d1'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(W / 2 - 40, y); ctx.lineTo(W / 2 + 40, y); ctx.stroke(); y += 40;
  ctx.fillStyle = '#292524'; ctx.font = '700 40px Georgia,serif'; ctx.fillText('ã€Œ' + type.name + 'ã€', W / 2, y); y += 32;
  ctx.fillStyle = '#78716c'; ctx.font = '400 20px Georgia,serif';
  tagLs.forEach((l, i) => ctx.fillText(l, W / 2, y + i * 28)); y += tagLs.length * 28 + 24;
  const cx = W / 2, cy = y + 90, R = 82;
  const angles = DIMS.map((_, i) => -Math.PI / 2 + (2 * Math.PI * i) / 5);
  for (let r = 1; r <= 4; r++) { const rr = (R / 4) * r; ctx.strokeStyle = '#e7e5e4'; ctx.lineWidth = 1; ctx.beginPath(); angles.forEach((a, i) => { const px = cx + rr * Math.cos(a), py = cy + rr * Math.sin(a); i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py); }); ctx.closePath(); ctx.stroke(); }
  ctx.fillStyle = 'rgba(168,162,158,0.3)'; ctx.strokeStyle = '#a8a29e'; ctx.lineWidth = 2; ctx.beginPath();
  DIMS.forEach((d, i) => { const v = sc1[d.key] / 100; const px = cx + R * v * Math.cos(angles[i]), py = cy + R * v * Math.sin(angles[i]); i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py); });
  ctx.closePath(); ctx.fill(); ctx.stroke();
  ctx.strokeStyle = '#b45309'; ctx.lineWidth = 2; ctx.setLineDash([5, 3]); ctx.beginPath();
  DIMS.forEach((d, i) => { const v = sc2[d.key] / 100; const px = cx + R * v * Math.cos(angles[i]), py = cy + R * v * Math.sin(angles[i]); i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py); });
  ctx.closePath(); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillStyle = '#57534e'; ctx.font = '400 14px Georgia,serif'; ctx.textAlign = 'center';
  DIMS.forEach((d, i) => { const lR = R + 20; ctx.fillText(d.label, cx + lR * Math.cos(angles[i]), cy + lR * Math.sin(angles[i]) + 5); });
  y = cy + R + 38;
  ctx.font = '400 12px Georgia,serif'; ctx.fillStyle = '#a8a29e'; ctx.fillRect(W / 2 - 80, y - 2, 10, 2);
  ctx.fillText('ç°çŠ¶', W / 2 - 58, y + 1); ctx.strokeStyle = '#b45309'; ctx.lineWidth = 1.5; ctx.setLineDash([4, 2]);
  ctx.beginPath(); ctx.moveTo(W / 2 + 16, y - 1); ctx.lineTo(W / 2 + 26, y - 1); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillStyle = '#b45309'; ctx.fillText('æ¸´æœ›', W / 2 + 44, y + 1); y += 22;
  const bL = 150, bMaxW = W - 230, bH = 7, bRow = 36;
  DIMS.forEach((d, i) => {
    const ry = y + i * bRow; const cur = sc1[d.key]; const des = sc2[d.key]; const gap = Math.max(des - cur, 0);
    ctx.fillStyle = '#57534e'; ctx.font = '500 14px Georgia,serif'; ctx.textAlign = 'right'; ctx.fillText(d.label, bL - 10, ry + 7);
    ctx.save(); ctx.fillStyle = '#f5f5f4'; roundRect(ctx, bL, ry, bMaxW, bH, 3.5); ctx.fill(); ctx.clip();
    ctx.fillStyle = '#a8a29e'; ctx.fillRect(bL, ry, Math.max((cur / 100) * bMaxW, 1), bH);
    if (gap > 0) { ctx.fillStyle = '#fbbf24'; ctx.fillRect(bL + (cur / 100) * bMaxW, ry, (gap / 100) * bMaxW, bH); }
    ctx.restore();
    ctx.fillStyle = '#78716c'; ctx.font = '600 11px Georgia,serif'; ctx.textAlign = 'left';
    ctx.fillText(`${cur} / ${des}`, bL + bMaxW + 8, ry + 7);
  });
  y += 5 * bRow + 14;
  const iCardP = 18; const iLnH = 20; const iCardH = iLC * iLnH + iCardP * 2;
  ctx.fillStyle = '#ffffff'; ctx.globalAlpha = 0.9; roundRect(ctx, PAD, y, W - PAD * 2, iCardH, 10); ctx.fill(); ctx.globalAlpha = 1;
  ctx.fillStyle = '#57534e'; ctx.font = '400 14px Georgia,serif'; ctx.textAlign = 'left';
  iL.forEach((l, i) => ctx.fillText(l, PAD + iCardP, y + iCardP + 13 + i * iLnH));
  if (hasMore) ctx.fillText('â€¦â€¦', PAD + iCardP, y + iCardP + 13 + iL.length * iLnH);
  y += iCardH + 18;
  ctx.strokeStyle = '#d6d3d1'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(W / 2 - 50, y); ctx.lineTo(W / 2 + 50, y); ctx.stroke(); y += 22;
  ctx.fillStyle = '#a8a29e'; ctx.font = '400 13px Georgia,serif'; ctx.textAlign = 'center'; ctx.fillText('å¯»æ‰¾ä½ çš„ç”Ÿå‘½æ”¯ç‚¹ Â· 2026', W / 2, y); y += 18;
  ctx.fillStyle = '#c4b5a3'; ctx.font = '400 11px Georgia,serif'; ctx.fillText('Â© å®‰æ¸…é…‰ AnQingYou', W / 2, y);
}

function PosterModal({ type, sc1, sc2, interp, onClose }) {
  const canvasRef = useRef(null);
  const [imgUrl, setImgUrl] = useState(null);
  useEffect(() => { const c = canvasRef.current; if (c) { drawPoster(c, type, sc1, sc2, interp); setImgUrl(c.toDataURL('image/png')); } }, [type, sc1, sc2, interp]);
  return (
    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4" onClick={onClose}>
      <motion.div initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} exit={{ scale: 0.9, opacity: 0 }} transition={{ type: 'spring', damping: 25 }} className="bg-white rounded-2xl overflow-hidden max-w-sm w-full max-h-screen flex flex-col" onClick={e => e.stopPropagation()}>
        <div className="flex items-center justify-between px-5 py-3 border-b border-stone-100">
          <span className="text-sm font-semibold text-stone-700" style={{ fontFamily: "'Noto Serif SC',Georgia,serif" }}>æˆ‘çš„ç”Ÿå‘½æ”¯ç‚¹</span>
          <button onClick={onClose} className="text-stone-400 hover:text-stone-600"><X size={20} /></button>
        </div>
        <div className="overflow-y-auto flex-1 p-3 bg-stone-50">
          <canvas ref={canvasRef} className="hidden" />
          {imgUrl && <img src={imgUrl} alt="poster" className="w-full rounded-xl shadow-lg" />}
        </div>
        <div className="px-5 py-3 border-t border-stone-100">
          <button onClick={() => { if (!imgUrl) return; const a = document.createElement('a'); a.href = imgUrl; a.download = 'æˆ‘çš„ç”Ÿå‘½æ”¯ç‚¹.png'; a.click(); }} className="w-full flex items-center justify-center gap-2 bg-stone-800 text-amber-50 py-3 rounded-full text-sm tracking-widest hover:bg-stone-700 transition-colors" style={{ fontFamily: "'Noto Serif SC',Georgia,serif" }}>
            <Download size={16} /> ä¿å­˜æµ·æŠ¥
          </button>
          <p className="text-center text-xs text-stone-400 mt-2" style={{ fontFamily: "'Noto Serif SC',Georgia,serif" }}>é•¿æŒ‰å›¾ç‰‡ä¹Ÿå¯ä¿å­˜åˆ°ç›¸å†Œ</p>
        </div>
      </motion.div>
    </motion.div>
  );
}

function DimGuide({ dims }) {
  const [open, setOpen] = useState(false);
  return (
    <div className="mx-5 mb-5">
      <button onClick={() => setOpen(!open)} className="flex items-center gap-1.5 text-xs text-stone-400 hover:text-stone-600 transition-colors mx-auto">
        <span>äº”ä¸ªç»´åº¦åˆ†åˆ«åŒ…å«ä»€ä¹ˆï¼Ÿ</span>
        {open ? <ChevronUp size={14} /> : <ChevronDown size={14} />}
      </button>
      <AnimatePresence>
        {open && (
          <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} transition={{ duration: 0.3 }} className="overflow-hidden">
            <div className="mt-3 bg-white rounded-2xl p-5 shadow-sm space-y-3">
              {dims.map(d => (
                <div key={d.key} className="flex items-start gap-3">
                  <span className="text-sm font-semibold text-stone-700 whitespace-nowrap pt-px">{d.label}</span>
                  <span className="text-xs text-stone-400 leading-relaxed pt-0.5">{d.desc}</span>
                </div>
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

export default function App() {
  const [page, setPage] = useState('cover');
  const [qi, setQi] = useState(0);
  const [a1, setA1] = useState(Array(25).fill(0));
  const [a2, setA2] = useState(Array(25).fill(0));
  const [dir, setDir] = useState(1);
  const [showPoster, setShowPoster] = useState(false);
  const [codeInput, setCodeInput] = useState('');
  const [codeError, setCodeError] = useState(false);
  const tmr = useRef(null);
  const F = "'Noto Serif SC','Songti SC',Georgia,'Times New Roman',serif";

  useEffect(() => {
    const l = document.createElement('link'); l.href = 'https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&display=swap'; l.rel = 'stylesheet'; document.head.appendChild(l);
    document.title = '2026ï¼šå¯»æ‰¾ä½ çš„ç”Ÿå‘½æ”¯ç‚¹';
  }, []);
  useEffect(() => { window.scrollTo(0, 0); }, [page]);

  const phase = page === 'phase1' ? 1 : page === 'phase2' ? 2 : 0;
  const qs = phase === 1 ? Q1 : Q2;
  const ans = phase === 1 ? a1 : a2;
  const opts = phase === 1 ? O1 : O2;
  const sc1 = useMemo(() => calc(a1, Q1), [a1]);
  const sc2 = useMemo(() => calc(a2, Q2), [a2]);

  const pick = (v) => {
    if (tmr.current) clearTimeout(tmr.current);
    if (phase === 1) setA1(p => { const n = [...p]; n[qi] = v; return n; });
    else setA2(p => { const n = [...p]; n[qi] = v; return n; });
    tmr.current = setTimeout(() => {
      setDir(1);
      if (qi < 24) setQi(qi + 1);
      else if (phase === 1) { setPage('transition'); setQi(0); }
      else setPage('result');
    }, 380);
  };
  const back = () => { if (tmr.current) clearTimeout(tmr.current); setDir(-1); if (qi > 0) setQi(qi - 1); else if (phase === 2) setPage('transition'); };
  const restart = () => { setPage('cover'); setQi(0); setA1(Array(25).fill(0)); setA2(Array(25).fill(0)); setCodeInput(''); setCodeError(false); };
  const validateCode = () => { const t = codeInput.trim().toUpperCase(); if (VALID_CODES.includes(t)) { setPage('phase1'); setCodeError(false); } else setCodeError(true); };

  return (
    <div style={{ fontFamily: F }} className="bg-amber-50 text-stone-800">

      {page === 'cover' && (
        <div className="min-h-screen flex items-center justify-center px-6">
          <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 1 }} className="text-center max-w-xs">
            <div className="text-6xl mb-8">âš–ï¸</div>
            <h1 className="text-3xl font-bold tracking-widest leading-snug">å¯»æ‰¾ä½ çš„<br />ç”Ÿå‘½æ”¯ç‚¹</h1>
            <p className="text-xs text-stone-400 tracking-widest mt-3 mb-10">2026 Â· LIFE FULCRUM</p>
            <div className="w-8 h-px bg-stone-300 mx-auto mb-8" />
            <p className="text-stone-500 leading-loose mb-10">
              æ¯æ®µäººç”Ÿ<br />éƒ½æœ‰ä¸€ä¸ªéšç§˜çš„æ”¯ç‚¹<br />æ‰¾åˆ°å®ƒ<br />
              <span className="font-semibold text-stone-700">è½»è½»ä¸€æ¨ï¼Œä¸€åˆ‡å¼€å§‹æ¾åŠ¨</span>
            </p>
            <p className="text-sm text-stone-400 leading-loose mb-10">50 é“é—®é¢˜<br />å¸®ä½ çœ‹è§æ­¤åˆ»çš„ä½ç½®<br />ä¹Ÿçœ‹è§ä½ çœŸæ­£æ¸´æœ›çš„æ–¹å‘</p>
            <button onClick={() => setPage('redeem')} className="bg-stone-800 text-amber-50 px-10 py-3.5 rounded-full tracking-widest hover:bg-stone-700 transition-colors shadow-xl">å¼€å§‹æ¢ç´¢</button>
            <p className="mt-8 text-xs text-stone-400">çº¦ 5â€“8 åˆ†é’Ÿ Â· è¯šå®é¢å¯¹è‡ªå·± Â· æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆ</p>
          </motion.div>
        </div>
      )}

      {page === 'redeem' && (
        <div className="min-h-screen flex items-center justify-center px-6">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.6 }} className="text-center max-w-xs w-full">
            <div className="mb-6 flex justify-center"><div className="w-14 h-14 rounded-full bg-stone-100 flex items-center justify-center"><Lock size={24} className="text-stone-400" /></div></div>
            <h2 className="text-2xl font-bold mb-3 tracking-wide">è¾“å…¥å…‘æ¢ç </h2>
            <p className="text-sm text-stone-500 leading-relaxed mb-8">è¯·è¾“å…¥ä½ çš„ä¸“å±å…‘æ¢ç ä»¥è§£é”æµ‹è¯•</p>
            <motion.div animate={codeError ? { x: [-8, 8, -8, 8, 0] } : { x: 0 }} transition={{ duration: 0.35 }}>
              <input type="text" value={codeInput} onChange={e => { setCodeInput(e.target.value.toUpperCase()); setCodeError(false); }} onKeyDown={e => { if (e.key === 'Enter') validateCode(); }} placeholder="XXXX-XXXX" maxLength={9} className="w-full text-center text-xl tracking-widest bg-transparent border-b-2 border-stone-300 py-3 outline-none focus:border-stone-600 transition-colors placeholder-stone-300" style={{ fontFamily: "'Courier New',Consolas,monospace" }} />
            </motion.div>
            {codeError && <motion.p initial={{ opacity: 0, y: -5 }} animate={{ opacity: 1, y: 0 }} className="text-red-400 text-sm mt-3">å…‘æ¢ç æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•</motion.p>}
            <button onClick={validateCode} className="w-full mt-8 bg-stone-800 text-amber-50 py-3.5 rounded-full tracking-widest hover:bg-stone-700 transition-colors shadow-xl">éªŒè¯å¹¶å¼€å§‹</button>
            <div className="w-8 h-px bg-stone-200 mx-auto mt-8 mb-5" />
            <a href="https://xhslink.com/m/9zlRIGza06v" target="_blank" rel="noopener noreferrer" className="text-sm text-amber-700 hover:text-amber-900 transition-colors">è¿˜æ²¡æœ‰å…‘æ¢ç ï¼Ÿ<span className="underline underline-offset-4">ç‚¹æ­¤è·å–</span> â†’</a>
            <button onClick={() => setPage('cover')} className="block mx-auto mt-6 text-xs text-stone-400 hover:text-stone-600 transition-colors">â† è¿”å›é¦–é¡µ</button>
          </motion.div>
        </div>
      )}

      {page === 'transition' && (
        <div className="min-h-screen flex items-center justify-center px-6">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.7 }} className="text-center max-w-xs">
            <motion.div className="w-16 h-16 rounded-full bg-amber-100 mx-auto mb-8 flex items-center justify-center" animate={{ scale: [1, 1.12, 1] }} transition={{ duration: 4, repeat: Infinity, ease: 'easeInOut' }}>
              <motion.div className="w-7 h-7 rounded-full bg-amber-200" animate={{ scale: [1, 0.85, 1] }} transition={{ duration: 4, repeat: Infinity, ease: 'easeInOut' }} />
            </motion.div>
            <h2 className="text-2xl font-bold mb-6">ç¬¬ä¸€é˜¶æ®µå®Œæˆ</h2>
            <p className="text-stone-500 leading-loose mb-3">ä½ å·²ç»è¯šå®åœ°é¢å¯¹äº†å½“ä¸‹çš„è‡ªå·±</p>
            <p className="text-stone-400 text-sm leading-relaxed mb-10">æ·±å‘¼å¸ä¸€æ¬¡<br />æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å¬å¬å†…å¿ƒçš„å£°éŸ³â€”â€”<br /><span className="font-semibold text-stone-700">ä½ çœŸæ­£æ¸´æœ›çš„ï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ</span></p>
            <button onClick={() => { setPage('phase2'); setQi(0); setDir(1); }} className="w-full bg-stone-800 text-amber-50 py-3.5 rounded-full tracking-widest hover:bg-stone-700 transition-colors shadow-xl mb-3">è¿›å…¥ç¬¬äºŒé˜¶æ®µ</button>
            <button onClick={() => { setPage('phase1'); setQi(24); setDir(-1); }} className="w-full text-stone-400 text-sm py-2 hover:text-stone-600 transition-colors">â† è¿”å›ä¿®æ”¹ç¬¬ä¸€é˜¶æ®µ</button>
          </motion.div>
        </div>
      )}

      {(page === 'phase1' || page === 'phase2') && (() => {
        const q = qs[qi]; const total = phase === 1 ? qi + 1 : 25 + qi + 1; const pct = total / 50 * 100;
        const pLabel = phase === 1 ? 'ç¬¬ä¸€é˜¶æ®µ Â· ç°çŠ¶æ‰«æ' : 'ç¬¬äºŒé˜¶æ®µ Â· å†…å¿ƒç½—ç›˜';
        const dim = DIMS.find(d => d.key === q.d);
        return (
          <div className="min-h-screen flex flex-col">
            <div className="px-5 pt-5 pb-3">
              <div className="flex items-center justify-between mb-3">
                <button onClick={back} disabled={phase === 1 && qi === 0} className="flex items-center gap-1 text-stone-400 hover:text-stone-600 disabled:opacity-20 transition-colors text-sm"><ChevronLeft size={18} /> ä¸Šä¸€é¢˜</button>
                <span className="text-xs text-stone-400 tracking-wider">{total} / 50</span>
              </div>
              <div className="w-full h-1 bg-stone-200 rounded-full overflow-hidden"><motion.div className="h-full rounded-full bg-stone-500" initial={false} animate={{ width: `${pct}%` }} transition={{ duration: 0.35 }} /></div>
              <p className="text-xs text-stone-400 mt-2.5 text-center tracking-widest">{pLabel}</p>
            </div>
            <div className="flex-1 flex flex-col items-center justify-center px-6 pb-10">
              <AnimatePresence mode="wait">
                <motion.div key={`${page}-${qi}`} initial={{ opacity: 0, x: dir * 50 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: dir * -50 }} transition={{ duration: 0.22 }} className="w-full max-w-sm text-center">
                  <p className="text-xs tracking-widest mb-3 text-amber-700">{dim?.label}</p>
                  <h3 className="text-lg font-medium leading-relaxed mb-10 px-2">{q.t}</h3>
                  <div className="space-y-2.5">
                    {opts.map((label, i) => { const v = i + 1; const sel = ans[qi] === v; return (
                      <button key={v} onClick={() => pick(v)} className={`w-full py-3 px-5 rounded-xl border text-sm transition-all duration-200 ${sel ? 'border-stone-700 bg-stone-800 text-amber-50 font-medium shadow-md' : 'border-stone-200 bg-white text-stone-600 hover:border-stone-400'}`}>{label}</button>
                    ); })}
                  </div>
                </motion.div>
              </AnimatePresence>
            </div>
          </div>
        );
      })()}

      {page === 'result' && (() => {
        const type = getType(sc1, sc2);
        const interp = getInterp(sc1, sc2);
        const sugg = getSugg(sc1, sc2);
        const data = DIMS.map(d => ({ dim: d.label, 'ç°çŠ¶': sc1[d.key], 'æ¸´æœ›': sc2[d.key] }));
        const { gapDim, gaps } = ana(sc1, sc2);
        const maxGap = gaps[gapDim];
        return (
          <div className="pb-16">
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ duration: 0.8 }} className="bg-gradient-to-b from-amber-100 to-amber-50 pt-14 pb-10 px-6 text-center">
              <p className="text-xs tracking-widest text-stone-400 mb-4">YOUR LIFE FULCRUM TYPE</p>
              <div className="w-8 h-px bg-stone-300 mx-auto mb-5" />
              <h2 className="text-4xl font-bold mb-5 tracking-wide">ã€Œ{type.name}ã€</h2>
              <p className="text-sm text-stone-600 leading-relaxed max-w-xs mx-auto">{type.tag}</p>
            </motion.div>

            <motion.div initial={{ opacity: 0, y: 20 }} whileInView={{ opacity: 1, y: 0 }} viewport={{ once: true }} transition={{ duration: 0.6 }} className="px-4 pt-8 pb-2">
              <h3 className="text-center font-semibold mb-1">èƒ½é‡å…¨æ™¯</h3>
              <p className="text-center text-xs text-stone-400 mb-3">ç°è‰² = ç°çŠ¶ Â· é‡‘è‰²è™šçº¿ = æ¸´æœ›</p>
              <div className="w-full h-72">
                <ResponsiveContainer>
                  <RadarChart data={data} cx="50%" cy="50%" outerRadius="65%">
                    <PolarGrid stroke="#d6d3d1" />
                    <PolarAngleAxis dataKey="dim" tick={{ fontSize: 12, fill: '#57534e' }} />
                    <PolarRadiusAxis angle={90} domain={[0, 100]} tick={false} axisLine={false} />
                    <Radar name="ç°çŠ¶" dataKey="ç°çŠ¶" stroke="#a8a29e" fill="#a8a29e" fillOpacity={0.35} strokeWidth={2} />
                    <Radar name="æ¸´æœ›" dataKey="æ¸´æœ›" stroke="#b45309" fill="#fbbf24" fillOpacity={0.1} strokeWidth={2.5} strokeDasharray="6 3" />
                    <Legend wrapperStyle={{ fontSize: 11, paddingTop: 4 }} />
                  </RadarChart>
                </ResponsiveContainer>
              </div>
            </motion.div>

            <DimGuide dims={DIMS} />

            <motion.div initial={{ opacity: 0, y: 20 }} whileInView={{ opacity: 1, y: 0 }} viewport={{ once: true }} transition={{ duration: 0.5 }} className="px-5 mb-6">
              <h3 className="font-semibold mb-3 tracking-wide text-sm">äº”ç»´å¯¹ç…§</h3>
              <div className="bg-white rounded-2xl p-5 shadow-sm">
                <div className="flex items-center justify-center gap-6 mb-5">
                  <span className="flex items-center gap-2 text-xs text-stone-500"><span className="w-2.5 h-2.5 rounded-full bg-stone-400 inline-block" /> ç°çŠ¶</span>
                  <span className="flex items-center gap-2 text-xs text-amber-600"><span className="w-2.5 h-2.5 bg-amber-500 inline-block" style={{ transform: 'rotate(45deg)' }} /> æ¸´æœ›</span>
                </div>
                <div className="space-y-5">
                  {DIMS.map((d, idx) => {
                    const cur = sc1[d.key], des = sc2[d.key], gap = Math.max(des - cur, 0);
                    return (
                      <div key={d.key}>
                        <div className="flex items-center justify-between mb-2">
                          <div>
                            <span className="text-sm font-medium text-stone-700">{d.label}</span>
                            <span className="text-xs text-stone-300 ml-2 hidden sm:inline">{d.desc}</span>
                          </div>
                          <div className="text-xs"><span className="text-stone-500 font-semibold">{cur}</span><span className="text-stone-300 mx-1">/</span><span className="text-amber-600 font-semibold">{des}</span></div>
                        </div>
                        <div className="relative h-5">
                          <div className="absolute top-1/2 left-0 right-0 h-px bg-stone-200" style={{ transform: 'translateY(-50%)' }} />
                          {[0, 25, 50, 75, 100].map(v => <div key={v} className="absolute w-px h-2 bg-stone-200" style={{ left: `${v}%`, top: '50%', transform: 'translate(-50%,-50%)' }} />)}
                          {gap > 0 && <motion.div className="absolute h-0.5 bg-amber-200" style={{ left: `${cur}%`, top: '50%', transform: 'translateY(-50%)' }} initial={{ width: 0 }} whileInView={{ width: `${gap}%` }} viewport={{ once: true }} transition={{ duration: 0.6, delay: idx * 0.08 + 0.3 }} />}
                          <motion.div className="absolute w-3 h-3 rounded-full bg-stone-500 border-2 border-white shadow-sm" style={{ left: `${cur}%`, top: '50%', transform: 'translate(-50%,-50%)' }} initial={{ scale: 0 }} whileInView={{ scale: 1 }} viewport={{ once: true }} transition={{ type: 'spring', delay: idx * 0.08 }} />
                          <motion.div className="absolute w-2.5 h-2.5 bg-amber-500 border-2 border-white shadow-sm" style={{ left: `${des}%`, top: '50%', transform: 'translate(-50%,-50%) rotate(45deg)' }} initial={{ scale: 0 }} whileInView={{ scale: 1 }} viewport={{ once: true }} transition={{ type: 'spring', delay: idx * 0.08 + 0.15 }} />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
              {maxGap > 10 && (
                <motion.div initial={{ opacity: 0, y: 10 }} whileInView={{ opacity: 1, y: 0 }} viewport={{ once: true }} transition={{ duration: 0.4, delay: 0.5 }} className="bg-amber-50 border border-amber-200 rounded-xl p-4 mt-3">
                  <p className="text-sm text-amber-800"><span className="font-semibold">ğŸ’¡ å…³é”®å‘ç°ï¼š</span>ã€Œ{dl(gapDim)}ã€æ˜¯ä½ ç°çŠ¶ä¸æ¸´æœ›å·®è·æœ€å¤§çš„ç»´åº¦ï¼ˆå·®è· {maxGap} åˆ†ï¼‰ï¼Œè¿™å¯èƒ½æ˜¯æ’¬åŠ¨æ”¹å˜æœ€æœ‰åŠ›çš„åˆ‡å…¥ç‚¹ã€‚</p>
                </motion.div>
              )}
            </motion.div>

            <motion.div initial={{ opacity: 0, y: 20 }} whileInView={{ opacity: 1, y: 0 }} viewport={{ once: true }} transition={{ duration: 0.5 }} className="px-5 mb-8">
              <h3 className="font-semibold mb-3 tracking-wide">æ ¸å¿ƒè§£è¯»</h3>
              <div className="bg-white rounded-2xl p-5 shadow-sm"><p className="text-sm leading-loose text-stone-600">{interp}</p></div>
            </motion.div>

            <motion.div initial={{ opacity: 0, y: 20 }} whileInView={{ opacity: 1, y: 0 }} viewport={{ once: true }} transition={{ duration: 0.5 }} className="px-5 mb-10">
              <h3 className="font-semibold mb-3 tracking-wide">æ’¬åŠ¨æ”¹å˜çš„ç¬¬ä¸€æ­¥</h3>
              <div className="space-y-3">{sugg.map((s, i) => (
                <div key={i} className="bg-white rounded-2xl p-5 shadow-sm">
                  <p className="font-medium text-sm mb-2 text-amber-800">{s.title}</p>
                  <p className="text-sm leading-loose text-stone-600">{s.text}</p>
                </div>
              ))}</div>
            </motion.div>

            <motion.div initial={{ opacity: 0 }} whileInView={{ opacity: 1 }} viewport={{ once: true }} transition={{ duration: 0.5 }} className="px-5 text-center">
              <div className="border-t border-stone-200 pt-8 mb-4">
                <div className="flex gap-3 justify-center">
                  <button onClick={() => setShowPoster(true)} className="flex-1 max-w-40 flex items-center justify-center gap-2 bg-stone-800 text-amber-50 py-3 rounded-full text-sm tracking-widest hover:bg-stone-700 transition-colors shadow-lg"><Share2 size={15} /> ç”Ÿæˆæµ·æŠ¥</button>
                  <button onClick={restart} className="flex-1 max-w-40 flex items-center justify-center gap-2 border border-stone-300 text-stone-600 py-3 rounded-full text-sm tracking-widest hover:bg-stone-100 transition-colors"><RotateCcw size={15} /> é‡æ–°æ¢ç´¢</button>
                </div>
              </div>
              <p className="text-xs text-stone-400 mt-4">âš ï¸ åˆ·æ–°é¡µé¢åç»“æœå°†ä¸¢å¤±ï¼Œå»ºè®®å…ˆä¿å­˜æµ·æŠ¥</p>
              <div className="w-8 h-px bg-stone-300 mx-auto mb-4 mt-4" />
              <p className="text-xs text-stone-400 tracking-wider">å¯»æ‰¾ä½ çš„ç”Ÿå‘½æ”¯ç‚¹ Â· 2026</p>
              <p className="text-xs text-stone-300 mt-1.5 tracking-wider">Â© å®‰æ¸…é…‰ AnQingYou</p>
            </motion.div>

            <AnimatePresence>
              {showPoster && <PosterModal type={getType(sc1, sc2)} sc1={sc1} sc2={sc2} interp={getInterp(sc1, sc2)} onClose={() => setShowPoster(false)} />}
            </AnimatePresence>
          </div>
        );
      })()}
    </div>
  );
}
